<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bun Munch</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }

      body {
        display: grid;
        place-items: center;
        background: #81befe;
        color: #eef7ff;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Arial,
          sans-serif;
        overflow: hidden;
      }

      .wrap {
        width: min(900px, 96vw);
        position: relative;
        z-index: 1;
      }

      canvas {
        width: 100%;
        height: auto;
        border-radius: 18px;
        box-shadow: 0 18px 60px rgba(57, 88, 111, 0.55);
        border: 1px solid rgba(118, 153, 185, 0.08);
        background: #7eb4e4;
      }

      .hud {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 10px 6px 14px;
        gap: 10px;
        font-size: 14px;
        opacity: 0.96;
        flex-wrap: wrap;
      }

      .pill {
        padding: 8px 12px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(6px);
        display: inline-flex;
        gap: 8px;
        align-items: center;
      }

      kbd {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-bottom-width: 2px;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 12px;
      }

      button {
        border: 0;
        border-radius: 999px;
        padding: 10px 16px;
        cursor: pointer;
        font-weight: 650;
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.14);
      }
      button:hover {
        background: rgba(255, 255, 255, 0.16);
      }

      .btns {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 14px;
        flex-wrap: wrap;
      }

      .overlay {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(10px);
        z-index: 10;
      }

      .card {
        width: min(620px, 92vw);
        border-radius: 22px;
        padding: 18px 18px 16px;
        background: #81befe;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.55);
        text-align: center;
        white-space: pre-line;
      }

      .title {
        font-size: 22px;
        margin: 6px 0 6px;
        font-weight: 800;
      }

      .subtitle {
        opacity: 0.92;
        margin: 0 0 10px;
        line-height: 1.35;
      }

      .tiny {
        opacity: 0.7;
        font-size: 12px;
        margin-top: 10px;
      }

      .clouds {
        position: fixed;
        inset: 0;
        z-index: 0;
        pointer-events: none;
        overflow: hidden;
      }

      .cloud {
        position: absolute;
        top: 10%;
        left: -30%;
        width: 220px;
        height: 70px;
        background: rgba(255, 255, 255, 0.75);
        border-radius: 999px;
        filter: blur(0.2px);
        box-shadow: 0 12px 30px rgba(255, 255, 255, 0.15);
        animation: drift linear infinite;
      }

      .cloud::before,
      .cloud::after {
        content: "";
        position: absolute;
        background: inherit;
        width: 90px;
        height: 90px;
        border-radius: 999px;
        top: -45px;
        left: 30px;
      }

      .cloud::after {
        width: 110px;
        height: 110px;
        top: -60px;
        left: 95px;
      }

      @keyframes drift {
        from {
          transform: translateX(-40vw);
        }
        to {
          transform: translateX(160vw);
        }
      }

      .c1 {
        top: 12%;
        transform: scale(1);
        opacity: 0.7;
        animation-duration: 55s;
      }
      .c2 {
        top: 26%;
        transform: scale(0.75);
        opacity: 0.55;
        animation-duration: 80s;
        animation-delay: -20s;
      }
      .c3 {
        top: 40%;
        transform: scale(1.25);
        opacity: 0.6;
        animation-duration: 65s;
        animation-delay: -35s;
      }
      .c4 {
        top: 18%;
        transform: scale(0.9);
        opacity: 0.45;
        animation-duration: 95s;
        animation-delay: -50s;
      }
    </style>
  </head>

  <body>
    <div class="clouds" aria-hidden="true">
      <div class="cloud c1"></div>
      <div class="cloud c2"></div>
      <div class="cloud c3"></div>
      <div class="cloud c4"></div>
    </div>

    <div class="wrap">
      <div class="hud">
        <div class="pill">Level: <span id="lvl">1</span> / 2</div>

        <div class="pill">
          Carrots: <span id="score">0</span> /
          <span id="goal">7</span>
        </div>

        <div class="pill">Objective: Munch carrots and avoid foxes</div>

        <div class="pill">
          Move: <kbd>WASD</kbd>/<kbd>Arrows</kbd> â€¢ Sprint: <kbd>Shift</kbd>
        </div>
      </div>

      <canvas id="game" width="900" height="520"></canvas>
    </div>

    <div class="overlay" id="overlay">
      <div class="card">
        <div class="title" id="ovTitle">Title</div>
        <p class="subtitle" id="ovText">Text</p>

        <img
          id="danceGif"
          src="dance.gif"
          alt="Here is a bunny dancing"
          style="
            display: none;
            width: min(360px, 90%);
            border-radius: 14px;
            margin: 10px auto 0;
          "
        />

        <div class="btns" id="ovBtns"></div>
        <p class="tiny" id="tipLine">Tip: I love you! You got this!</p>
      </div>
    </div>

    <script>
      const FINAL_QUESTION =
        "You made it past 2 levels and collected 14 carrots.\nWill you be my valentine on 2/14? <3";

      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");

      const lvlEl = document.getElementById("lvl");
      const scoreEl = document.getElementById("score");
      const goalEl = document.getElementById("goal");

      const overlay = document.getElementById("overlay");
      const ovTitle = document.getElementById("ovTitle");
      const ovText = document.getElementById("ovText");
      const ovBtns = document.getElementById("ovBtns");
      const yesGif = document.getElementById("danceGif");
      const tipLine = document.getElementById("tipLine");

      const keys = new Set();
      window.addEventListener("keydown", (e) => {
        keys.add(e.key.toLowerCase());
        if (
          ["arrowup", "arrowdown", "arrowleft", "arrowright", " "].includes(
            e.key.toLowerCase(),
          )
        )
          e.preventDefault();
      });
      window.addEventListener("keyup", (e) => keys.delete(e.key.toLowerCase()));

      function rand(min, max) {
        return Math.random() * (max - min) + min;
      }
      function clamp(v, a, b) {
        return Math.max(a, Math.min(b, v));
      }
      function dist2(ax, ay, bx, by) {
        const dx = ax - bx,
          dy = ay - by;
        return dx * dx + dy * dy;
      }
      function circleCollide(ax, ay, ar, bx, by, br) {
        return dist2(ax, ay, bx, by) <= (ar + br) * (ar + br);
      }

      const bg = document.createElement("canvas");
      bg.width = canvas.width;
      bg.height = canvas.height;
      const bctx = bg.getContext("2d");

      function buildGrassBackground() {
        const g = bctx.createLinearGradient(0, 0, 0, bg.height);
        g.addColorStop(0, "#6fd26f");
        g.addColorStop(0.55, "#2fa94a");
        g.addColorStop(1, "#1f7f35");
        bctx.fillStyle = g;
        bctx.fillRect(0, 0, bg.width, bg.height);

        const vg = bctx.createRadialGradient(
          bg.width * 0.5,
          bg.height * 0.4,
          50,
          bg.width * 0.5,
          bg.height * 0.4,
          650,
        );
        vg.addColorStop(0, "rgba(255,255,255,0.08)");
        vg.addColorStop(1, "rgba(0,0,0,0.20)");
        bctx.fillStyle = vg;
        bctx.fillRect(0, 0, bg.width, bg.height);

        bctx.globalAlpha = 0.18;
        for (let i = 0; i < 65; i++) {
          const y = i * (bg.height / 65);
          bctx.fillStyle =
            i % 2 === 0 ? "rgba(0,0,0,0.10)" : "rgba(255,255,255,0.06)";
          bctx.fillRect(0, y, bg.width, 6);
        }
        bctx.globalAlpha = 1;

        for (let i = 0; i < 1800; i++) {
          const x = rand(0, bg.width);
          const y = rand(0, bg.height);
          const r = rand(0.6, 1.8);
          const a = rand(0.05, 0.12);
          bctx.fillStyle = `rgba(0,0,0,${a})`;
          bctx.beginPath();
          bctx.arc(x, y, r, 0, Math.PI * 2);
          bctx.fill();
        }

        for (let i = 0; i < 120; i++) {
          const x = rand(18, bg.width - 18);
          const y = rand(30, bg.height - 18);
          const a = rand(0.1, 0.22);
          bctx.fillStyle = `rgba(255,255,255,${a})`;
          bctx.beginPath();
          bctx.arc(x, y, 1.5, 0, Math.PI * 2);
          bctx.fill();

          bctx.fillStyle = `rgba(255,170,210,${a})`;
          bctx.beginPath();
          bctx.arc(x + 2, y + 1, 1.2, 0, Math.PI * 2);
          bctx.fill();
        }
      }
      buildGrassBackground();

      if (!CanvasRenderingContext2D.prototype.roundRect) {
        CanvasRenderingContext2D.prototype.roundRect = function (
          x,
          y,
          w,
          h,
          r,
        ) {
          r = Math.min(r, w / 2, h / 2);
          this.beginPath();
          this.moveTo(x + r, y);
          this.arcTo(x + w, y, x + w, y + h, r);
          this.arcTo(x + w, y + h, x, y + h, r);
          this.arcTo(x, y + h, x, y, r);
          this.arcTo(x, y, x + w, y, r);
          this.closePath();
          return this;
        };
      }

      const LEVELS = 2;
      const PER_LEVEL = 7;
      goalEl.textContent = PER_LEVEL;

      const bunny = { x: 140, y: 260, r: 16, vx: 0, vy: 0 };
      let carrots = [];
      let foxes = [];

      let level = 1;
      let levelScore = 0;
      let totalScore = 0;
      let last = performance.now();

      function updateHUD() {
        lvlEl.textContent = level;
        scoreEl.textContent = levelScore;
      }

      function clearOverlay() {
        overlay.style.display = "none";
        ovBtns.innerHTML = "";
        yesGif.style.display = "none";
      }

      function showOverlay(title, text, buttons, showTip = false) {
        ovTitle.textContent = title;
        ovText.textContent = text;
        ovBtns.innerHTML = "";
        yesGif.style.display = "none";

        tipLine.style.display = showTip ? "block" : "none";

        for (const b of buttons) {
          const btn = document.createElement("button");
          btn.textContent = b.label;
          btn.onclick = b.onClick;
          ovBtns.appendChild(btn);
        }
        overlay.style.display = "grid";
      }

      function spawnCarrot() {
        const tries = 90;
        for (let i = 0; i < tries; i++) {
          const c = {
            x: rand(60, canvas.width - 60),
            y: rand(60, canvas.height - 60),
            r: 13,
            bob: rand(0, Math.PI * 2),
            glow: rand(0.55, 1.0),
          };
          if (!circleCollide(c.x, c.y, c.r, bunny.x, bunny.y, bunny.r + 60)) {
            let ok = true;
            for (const f of foxes) {
              if (circleCollide(c.x, c.y, c.r, f.x, f.y, f.r + 30)) {
                ok = false;
                break;
              }
            }
            if (ok) {
              carrots.push(c);
              return;
            }
          }
        }
        carrots.push({
          x: canvas.width * 0.7,
          y: canvas.height * 0.3,
          r: 13,
          bob: 0,
          glow: 0.9,
        });
      }

      function spawnFox() {
        const edge = Math.floor(rand(0, 4));
        let x, y;
        if (edge === 0) {
          x = -25;
          y = rand(0, canvas.height);
        }
        if (edge === 1) {
          x = canvas.width + 25;
          y = rand(0, canvas.height);
        }
        if (edge === 2) {
          x = rand(0, canvas.width);
          y = -25;
        }
        if (edge === 3) {
          x = rand(0, canvas.width);
          y = canvas.height + 25;
        }

        const speed = level === 1 ? rand(60, 100) : rand(70, 110);
        foxes.push({ x, y, r: 16, sp: speed, wob: rand(0, Math.PI * 2) });
      }

      function setupLevel(lvl) {
        level = lvl;
        levelScore = 0;
        carrots = [];
        foxes = [];

        bunny.x = canvas.width * 0.15;
        bunny.y = canvas.height * 0.55;
        bunny.vx = 0;
        bunny.vy = 0;

        spawnCarrot();
        spawnCarrot();

        if (level === 1) {
          spawnFox();
        } else {
          spawnFox();
          spawnFox();
        }

        last = performance.now();
        clearOverlay();
        updateHUD();
      }

      function restartGame() {
        totalScore = 0;
        setupLevel(1);
      }

      function restartLevel() {
        setupLevel(level);
      }

      function drawCarrot(x, y, s, t) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(Math.sin(t * 0.002) * 0.18);

        ctx.fillStyle = "rgba(90, 220, 120, 0.95)";
        ctx.beginPath();
        ctx.moveTo(-5 * s, -16 * s);
        ctx.quadraticCurveTo(-2 * s, -28 * s, 0, -18 * s);
        ctx.quadraticCurveTo(2 * s, -28 * s, 5 * s, -16 * s);
        ctx.quadraticCurveTo(0, -21 * s, -5 * s, -16 * s);
        ctx.fill();

        ctx.fillStyle = "rgba(255, 150, 50, 0.97)";
        ctx.beginPath();
        ctx.moveTo(0, 18 * s);
        ctx.quadraticCurveTo(-11 * s, 7 * s, -7 * s, -13 * s);
        ctx.quadraticCurveTo(0, -17 * s, 7 * s, -13 * s);
        ctx.quadraticCurveTo(11 * s, 7 * s, 0, 18 * s);
        ctx.closePath();
        ctx.fill();

        ctx.strokeStyle = "rgba(190, 95, 25, 0.55)";
        ctx.lineWidth = 2;
        for (let i = -1; i <= 1; i++) {
          ctx.beginPath();
          ctx.moveTo(-3.5 * s, i * 6 * s);
          ctx.lineTo(3.5 * s, (i * 6 - 2) * s);
          ctx.stroke();
        }

        ctx.restore();
      }

      function drawBunny(x, y, t) {
        ctx.save();
        ctx.translate(x, y);
        const bob = Math.sin(t * 0.006) * 2.1;

        ctx.fillStyle = "rgba(0,0,0,0.18)";
        ctx.beginPath();
        ctx.ellipse(0, 18 + bob, 18, 8, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "rgba(255,255,255,0.97)";
        ctx.beginPath();
        ctx.roundRect(-12, -34 + bob, 9, 26, 7);
        ctx.roundRect(3, -36 + bob, 9, 28, 7);
        ctx.fill();

        ctx.fillStyle = "rgba(255,170,210,0.55)";
        ctx.beginPath();
        ctx.roundRect(-10, -30 + bob, 5, 18, 5);
        ctx.roundRect(5, -32 + bob, 5, 20, 5);
        ctx.fill();

        ctx.fillStyle = "rgba(255,255,255,0.97)";
        ctx.beginPath();
        ctx.roundRect(-18, -16 + bob, 36, 30, 14);
        ctx.fill();

        ctx.fillStyle = "rgba(25,25,35,0.9)";
        ctx.beginPath();
        ctx.arc(-6, -2 + bob, 2.4, 0, Math.PI * 2);
        ctx.arc(6, -2 + bob, 2.4, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "rgba(255,120,160,0.9)";
        ctx.beginPath();
        ctx.arc(0, 3 + bob, 2.6, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
      }

      function drawFox(x, y, r, t) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(Math.sin(t * 0.003) * 0.18);

        ctx.fillStyle = "rgba(0,0,0,0.18)";
        ctx.beginPath();
        ctx.ellipse(0, r * 0.95, r * 1.0, r * 0.45, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "rgba(255, 105, 80, 0.95)";
        ctx.beginPath();
        ctx.ellipse(0, 0, r * 0.95, r * 0.7, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(-r * 0.65, -r * 0.1);
        ctx.lineTo(-r * 0.2, -r * 0.95);
        ctx.lineTo(0, -r * 0.25);
        ctx.closePath();
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(r * 0.65, -r * 0.1);
        ctx.lineTo(r * 0.2, -r * 0.95);
        ctx.lineTo(0, -r * 0.25);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = "rgba(255,255,255,0.88)";
        ctx.beginPath();
        ctx.ellipse(0, r * 0.22, r * 0.36, r * 0.26, 0, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "rgba(25,25,35,0.9)";
        ctx.beginPath();
        ctx.arc(-r * 0.25, 0, r * 0.11, 0, Math.PI * 2);
        ctx.arc(r * 0.25, 0, r * 0.11, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
      }

      function caughtByFox() {
        showOverlay("You were caught by a fox :(", "Try again?", [
          { label: "Restart Level", onClick: () => restartLevel() },
          { label: "Restart Game", onClick: () => restartGame() },
        ]);
      }

      function levelComplete() {
        if (level < LEVELS) {
          showOverlay(
            `Level ${level} Complete!`,
            `You collected ${PER_LEVEL} carrots.\nReady for Level ${level + 1}?`,
            [
              {
                label: `Start Level ${level + 1}`,
                onClick: () => setupLevel(level + 1),
              },
              { label: "Restart Game", onClick: () => restartGame() },
            ],
          );
        } else {
          function askValentine(prefix = "") {
            showOverlay(
              "You Win!S",
              (prefix ? prefix + "\n\n" : "") + FINAL_QUESTION,
              [
                {
                  label: "Yes",
                  onClick: () => {
                    yesGif.style.display = "block";
                    ovTitle.textContent = "YAY NOM";
                    ovBtns.innerHTML = "";
                    ovText.textContent = "";
                    tipLine.style.display = "none";

                    const btn = document.createElement("button");
                    btn.textContent = "Play Again";
                    btn.onclick = () => restartGame();
                    ovBtns.appendChild(btn);
                  },
                },
                {
                  label: "No",
                  onClick: () => askValentine("Try again"),
                },
              ],
              false,
            );
          }
          askValentine();
        }
      }

      function tick(now) {
        const dt = Math.min(0.033, (now - last) / 1000);
        last = now;

        const paused = overlay.style.display === "grid";

        const up = keys.has("w") || keys.has("arrowup");
        const down = keys.has("s") || keys.has("arrowdown");
        const left = keys.has("a") || keys.has("arrowleft");
        const right = keys.has("d") || keys.has("arrowright");
        const sprint = keys.has("shift");

        const accel = sprint ? 900 : 650;
        const maxV = sprint ? 340 : 250;
        const friction = 0.86;

        if (!paused) {
          let ax = 0,
            ay = 0;
          if (up) ay -= accel;
          if (down) ay += accel;
          if (left) ax -= accel;
          if (right) ax += accel;

          bunny.vx = (bunny.vx + ax * dt) * friction;
          bunny.vy = (bunny.vy + ay * dt) * friction;

          const sp = Math.hypot(bunny.vx, bunny.vy);
          if (sp > maxV) {
            const k = maxV / sp;
            bunny.vx *= k;
            bunny.vy *= k;
          }

          bunny.x += bunny.vx * dt;
          bunny.y += bunny.vy * dt;
          bunny.x = clamp(bunny.x, bunny.r + 6, canvas.width - bunny.r - 6);
          bunny.y = clamp(bunny.y, bunny.r + 6, canvas.height - bunny.r - 6);
        }

        if (!paused) {
          for (const f of foxes) {
            const dx = bunny.x - f.x;
            const dy = bunny.y - f.y;
            const d = Math.hypot(dx, dy) || 1;

            f.wob += dt * (level === 1 ? 2.2 : 2.8);
            const wob = 1 + Math.sin(f.wob) * 0.1;

            f.x += (dx / d) * f.sp * dt * wob;
            f.y += (dy / d) * f.sp * dt * wob;

            if (circleCollide(bunny.x, bunny.y, bunny.r, f.x, f.y, f.r)) {
              caughtByFox();
              break;
            }
          }
        }

        if (!paused) {
          for (let i = carrots.length - 1; i >= 0; i--) {
            const c = carrots[i];
            c.bob += dt * 4.2;

            if (circleCollide(bunny.x, bunny.y, bunny.r, c.x, c.y, c.r)) {
              carrots.splice(i, 1);
              levelScore++;
              totalScore++;
              updateHUD();

              if (levelScore >= PER_LEVEL) {
                levelComplete();
                break;
              } else {
                spawnCarrot();
                if (level === 2 && levelScore % 3 === 0) spawnFox();
              }
            }
          }
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bg, 0, 0);

        ctx.globalAlpha = 0.1;
        ctx.fillStyle = "#ffffff";
        const sweepX = (Math.sin(now * 0.00025) * 0.5 + 0.5) * canvas.width;
        ctx.beginPath();
        ctx.ellipse(sweepX, canvas.height * 0.35, 320, 190, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;

        for (const c of carrots) {
          const pulse = Math.sin(c.bob) * 0.12 + 0.98;
          ctx.shadowColor = "rgba(255,150,50,0.28)";
          ctx.shadowBlur = 18 * c.glow;
          drawCarrot(c.x, c.y, pulse, now);
          ctx.shadowBlur = 0;
        }

        ctx.shadowColor = "rgba(0,0,0,0.18)";
        ctx.shadowBlur = 10;
        for (const f of foxes) drawFox(f.x, f.y, f.r, now);
        ctx.shadowBlur = 0;

        ctx.shadowColor = "rgba(0,0,0,0.16)";
        ctx.shadowBlur = 10;
        drawBunny(bunny.x, bunny.y, now);
        ctx.shadowBlur = 0;

        updateHUD();
        requestAnimationFrame(tick);
      }

      function start() {
        totalScore = 0;
        setupLevel(1);
        requestAnimationFrame(tick);
      }
      start();
    </script>
  </body>
</html>
